---
title: "COVID proteomics"
author: "Marek Gierlinski"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    theme:
      bootswatch: journal
      primary: "#2fa4e7"
---

```{css css_options, echo=FALSE}
pre code, pre, code {
  white-space: pre !important;
  overflow-x: scroll_box() ! important; 
  word-break: keep-all !important;
  word-wrap: initial !important;
}
```

```{r options, echo=FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = FALSE,
  cache = TRUE,
  autodep = TRUE
)
options(
  width = 100,
  knitr.table.format = "html"
)
```

```{r libraries, cache=FALSE}
library(targets)
library(tidyverse)
library(flextable)
library(DT)
```

```{r functions}
myDT <- function(d) {
  datatable(d, class = "table-condensed table-striped table-bordered", style = "bootstrap") %>% 
    formatStyle(columns = colnames(d), fontSize = '90%')
}
N <- function(n) prettyNum(n, big.mark = ",")
```

Collaborators: Merete Long, James Chalmers

#  {.tabset}

## Proposal


## Data

### Spectronaut

Raw data were analysed with [Spectronaut](https://biognosys.com/software/spectronaut). I have received one CSV file at protein level (one row per protein/protein group) with raw and normalised abundances and some additional QC information.

### Protein detection

Not all proteins are detected across all `r tar_read(n_samples)` samples. Figure below shows in how many samples each protein was detected, starting from the highest number. There are `r N(tar_read(n_full_detection))` proteins detected across all samples.

```{r detection, fig.width=10, fig.height=4}
tar_read(fig_detection)
```


## Experiment

We have a lot of samples. There are two treatments (drug and placebo), several time points and batches. Here is a summary of the sample numbers:

```{r meta_day}
tar_read(metadata) %>%
  group_by(treatment, day) %>% 
  tally() %>% 
  flextable() %>% 
  theme_box() %>% 
  merge_v(j = 1)
```

```{r meta_batch}
tar_read(metadata) %>%
  group_by(batch, day) %>% 
  tally() %>% 
  flextable() %>% 
  theme_box() %>% 
  merge_v(j = 1)
```

## Overview


### Abundance distribution

The plot shows distribution of raw and normalised protein abundance:

```{r fig_abu_dist, out.width="60%"}
knitr::include_graphics("../fig/kernels.png")
```

### Clustering

```{r fig_clustering, fig.width=8, fig.height=40}
tar_read(fig_clustering)
```

### Correlation matrix

```{r cormat, fig.width=10, fig.height=10}
tar_read(fig_cormat) 
```

### PCA

```{r pca, fig.width=8, fig.height=8}
tar_read(fig_pca)
```

### UMAP

```{r umap, fig.width=8, fig.height=8}
tar_read(fig_umap) 
```


## Differential abundance

### Description

#### From limma R vignette

For differential expression we use `limma`. It used an empirical Bayes method to squeeze the peptide-wise residual variances towards a common value (or towards a global trend) (Smyth, 2004; Phipson et al, 2016). The degrees of freedom for the individual variances are increased to reflect the extra information gained from the empirical Bayes moderation, resulting in increased statistical power to detect differential expression.

For more information see [Ritchie et al. 2015](https://academic.oup.com/nar/article/43/7/e47/2414268).

#### In simpler words

`limma` uses a t-test, which is moderated by borrowing data across all peptides. A global variance model is built and moderation squeezes variances towards this global trend. Extreme variances (either large or small) become less extreme, which makes the test more robust to random outliers.

### Results

```{r fig_pep_volcano, fig.width=12, fig.height=4}
tar_read(fig_volcano)
```

## Resources

-   [Interactive data explorer]()
-   [Download DE results]()

## Session info

```{r session_info}
sessionInfo()
```
